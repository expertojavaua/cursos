<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Despliegue de servicios web con Axis2 y CXF</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/cursos/sws"><img class="logoImage" alt="jtech" src="images/baner_j2ee_izq.gif" title="Especialista Universitario Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Servicios Web seguros" src="images/baner_j2ee_der.gif" title="Servicios Web seguros"></a>
</div>
<ul id="tabs">
<li class="current">
<a class="base-selected" href="index.html">Apuntes</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Servicios Web seguros</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Servicios Web seguros">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Sesiones</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesi&oacute;n 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html">Sesi&oacute;n 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html">Sesi&oacute;n 8</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 9</div>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html">Sesi&oacute;n 10</a>
</div>
<div class="menuitem">
<a href="sesion11-apuntes.html">Sesi&oacute;n 11</a>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html">Sesi&oacute;n 12</a>
</div>
<div class="menuitem">
<a href="roadmap-apuntes.html" title="Roadmap">Roadmap</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion09-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Despliegue de servicios web con Axis2 y CXF</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Despliegue+en+Axis2">Despliegue en Axis2</a>
</li>
<li>
<a href="#Despliegue+de+servicios+Axis2+en+Tomcat">Despliegue de servicios Axis2 en Tomcat</a>
</li>
<li>
<a href="#Despliegue+de+servicios+CXF+en+Tomcat">Despliegue de servicios CXF en Tomcat</a>
</li>
<li>
<a href="#Ejercicios">Ejercicios</a>
<ul class="minitoc">
<li>
<a href="#Despliegue+de+la+calculadora+con+firma">Despliegue de la calculadora con firma</a>
</li>
</ul>
</li>
</ul>
</div>




<a name="N1000E"></a><a name="Despliegue+en+Axis2"></a>
<h2 class="underlined_10">Despliegue en Axis2</h2>
<div class="section">
<p>Para desplegar (deploy) un archivo en Axis2, hay que copiar el 
paquete AAR del proyecto servidor a la carpeta 
<span class="codefrag">axis2-1.5.1/repository/services/</span> y esperar unos segundos 
a que Axis2 lo detecte. Para eliminarlo (undeploy) tan s&oacute;lo hay que 
eliminarlo de ah&iacute;. </p>
<p>Para generar el paquete, pulsamos con el bot&oacute;n derecho sobre la ra&iacute;z 
del proyecto <span class="codefrag">Axis2SWSeguroServidor</span> y pulsamos Run as... Maven package. 
Se descargan una serie de archivos y se genera el paquete en formato 
.jar, cuya ruta se indica en la salida por consola:</p>
<pre class="code"> 
[...]
Tests run: 0, Failures: 0, Errors: 0, Skipped: 0

[INFO] 
[INFO] --- maven-jar-plugin:2.2:jar (default-jar) @ SWSeguroServidor ---
[INFO] Building jar: /home/servicios/workspace/Axis2SWSeguroServidor/target/
                                         SWSeguroServidor-0.0.1-SNAPSHOT.jar
[INFO] -------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] -------------------------------------------------------
[INFO] Total time: 13.411s
[INFO] Finished at: Thu May 20 13:13:07 CEST 2010
[INFO] Final Memory: 4M/15M
[INFO] -------------------------------------------------------

</pre>
<p>Podemos copiarlo tal cu&aacute;l a la carpeta de servicios del repositorio de 
Axis2, o bien podemos copiarlo con el nombre y la extensi&oacute;n cambiados:
</p>
<pre class="code"> 
servicios@servicios:~$ cp /home/servicios/workspace/Axis2SWSeguroServidor/
                                      target/SWSeguroServidor-0.0.1-SNAPSHOT.jar 
                                    axis2-1.5.1/repository/services/SWSeguro.aar

</pre>
<p>En la consola donde est&eacute; ejecutado el servidor de Axis2, observamos:
</p>
<pre class="code"> 
[INFO] Deploying Web service: SWSeguro.aar - 
               file:/home/servicios/axis2-1.5.1/repository/services/SWSeguro.aar

</pre>
<p>Si ahora ejecutamos el cliente en esta misma consola obtenemos 
informaci&oacute;n sobre la verificaci&oacute;n de los tokens del mensaje del cliente, 
mientras que en la consola del cliente obtenemos la respuesta (el saludo), 
que ha venido codificada, como podemos comprobar en la captura del TCP Monitor.
</p>
</div> 

<a name="N10038"></a><a name="Despliegue+de+servicios+Axis2+en+Tomcat"></a>
<h2 class="underlined_10">Despliegue de servicios Axis2 en Tomcat</h2>
<div class="section">
<p>Apache-Tomcat se descarga de 
<a href="http://tomcat.apache.org">http://tomcat.apache.org</a>. 
Descargamos la versi&oacute;n 6, y obtenemos un archivo comprimido 
<span class="codefrag">apache-tomcat-6.0.26.tar.gz</span> que descompimimos en la 
carpeta donde vayamos a instalarlo.</p>
<pre class="code"> 
servicios@servicios:~$ tar xzvf apache-tomcat-6.0.26.tar.gz 
servicios@servicios:~$ rm apache-tomcat-6.0.26.tar.gz
servicios@servicios:~$ ./apache-tomcat-6.0.26/bin/startup.sh

</pre>
<p>El &uacute;ltimo comando ejecuta apache tomcat s&oacute;lo si la variable 
<span class="codefrag">JAVA_HOME</span> est&aacute; correctamente definida.
Ahora podemos acceder con el navegador web a la URL 
<a href="http://localhost:8080/">http://localhost:8080/</a>.
Apagamos el servidor para a&ntilde;adir un usuario administrador:
</p>
<pre class="code">
servicios@servicios:~$ ./apache-tomcat-6.0.26/bin/shutdown.sh
</pre>
<p>Editamos el archivo <span class="codefrag">apache-tomcat-6.0.26/conf/tomcat-users.xml</span>
 y a&ntilde;adimos el usuario:
</p>
<pre class="code"> 
&lt;role rolename="manager"/&gt;
&lt;user username="servicios" password="servicios" roles="manager" /&gt;

</pre>
<p>Volvemos a arrancar el servidor de apache-tomcat y ya podemos 
entrar en la secci&oacute;n "Tomcat Manager" del men&uacute; de aministraci&oacute;n que hay 
arriba a la izquierda, con usuario y contrase&ntilde;a "<span class="codefrag">servicios</span>". 
En esta p&aacute;gina hay una secci&oacute;n de despliegue que nos permite 
seleccionar un archivo WAR a cargar para desplegar. Esta es una de las
maneras de desplegar una aplicaci&oacute;n web en Tomcat. La otra forma es 
copi&aacute;ndola a la carpeta <span class="codefrag">apache-tomcat-6.0.26/webapps</span>. 
</p>
<p>Para desplegar servicios de CXF tendremos que empaquetarlos 
en un archivo WAR y desplegarlo directamente en Tomcat. 
Para desplegar en Axis2 tendremos que desplegar el archivo <span class="codefrag">axis2.war</span> 
que podemos descargar de la direcci&oacute;n 
<a href="http://ws.apache.org/axis2/download/1_5_1/download.cgi">http://ws.apache.org/axis2/download/1_5_1/download.cgi</a>. 
El archivo .war est&aacute; en un .zip, lo descomprimimos y desplegamos 
en tomcat el archivo .war. El interfaz web nos devuelve la respuesta 
"Mensaje: OK" y en la lista de aplicaciones aparecer&aacute; <span class="codefrag">/axis2</span>.
</p>
<p>Ahora podemos acceder con el navegador web a la URL 
<a href="http://localhost:8080/axis2/">http://localhost:8080/axis2/</a> donde nos 
permite ver la lista de servicios y administrar. 
Mientras Axis2 est&eacute; desplegado en Tomcat, tendremos su estructura de 
carpetas y podremos desplegar nuestros servicios de Axis2 
copiando sus paquetes .aar a la carpeta 
</p>
<pre class="code">
apache-tomcat-6.0.26/webapps/axis2/WEB-INF/services/
</pre>
<p>El despliegue se har&aacute; en caliente (pasados unos segundos lo 
autodetectar&aacute; y desplegar&aacute;). Para ver las excepciones tendremos 
que ver el archivo de log de Tomcat:
</p>
<pre class="code">
servicios@servicios:~$ cat apache-tomcat-6.0.26/logs/catalina.out 
servicios@servicios:~$ tail -n 20 apache-tomcat-6.0.26/logs/catalina.out 
</pre>
<p>Ahora vamos a copiar los m&oacute;dulos de Rampart a la estructura de 
directorios de Axis2.
</p>
<pre class="code">
servicios@servicios:~$ cp rampart-1.5/modules/* 
                             apache-tomcat-6.0.26/webapps/axis2/WEB-INF/modules/
servicios@servicios:~$ cp rampart-1.5/lib/* 
                                 apache-tomcat-6.0.26/webapps/axis2/WEB-INF/lib/
</pre>
<p>Reiniciamos Axis2 desde la p&aacute;gina de administraci&oacute;n de Tomcat:
</p>
<p>
<img alt="Aplicaciones en el Manager de Tomcat" content-width="8.03cm" src="imagenes/sws/31.png" width="669"></p>
<div class="frame note">
<div class="label">Nota</div>
<div class="content">Nota: la opci&oacute;n "Replegar" elimina el despliegue, es decir, 
realiza el "Undeploy".
</div>
</div>
<p>Vamos a desplegar el servicio web de Axis2 que tenemos en 
<span class="codefrag">/home/servicios/workspace/Axis2SWSeguroServidor/target/
SWSeguroServidor-0.0.1-SNAPSHOT.jar:</span>
</p>
<pre class="code"> 
servicios@servicios:~$ cp /home/servicios/workspace/Axis2SWSeguroServidor/
                                      target/SWSeguroServidor-0.0.1-SNAPSHOT.jar 
/home/servicios/apache-tomcat-6.0.26/webapps/axis2/WEB-INF/services/
                                                                    SWSeguro.aar
servicios@servicios:~$ tail -n 5 apache-tomcat-6.0.26/logs/catalina.out 
[...]
[INFO] Deploying module: rampart-1.5 - file:/home/servicios/
              apache-tomcat-6.0.26/webapps/axis2/WEB-INF/modules/rampart-1.5.mar
[INFO] Deploying Web service: SWSeguro.aar - file:/home/servicios/
                apache-tomcat-6.0.26/webapps/axis2/WEB-INF/services/SWSeguro.aar

</pre>
<p>En primer lugar comprobamos en el log que el servicio se ha desplegado 
sin excepciones. En segundo lugar podemos comprobar con el navegador 
(<a href="http://localhost:8080/axis2/services/listServices">http://localhost:8080/axis2/services/listServices</a>) 
que nuestro servicio est&aacute; listado en Axis2 y que su WSDL se puede descargar. 
Por &uacute;ltimo, ejecutamos nuestro cliente (indicando en el endpoint que el 
puerto es el 8080, a menos que tengamos el TCP Monitor redirigiendo 
los paquetes ah&iacute;), y comprobamos que el cliente obtiene la respuesta correcta.
</p>
</div> 


<a name="N100B3"></a><a name="Despliegue+de+servicios+CXF+en+Tomcat"></a>
<h2 class="underlined_10">Despliegue de servicios CXF en Tomcat</h2>
<div class="section">
<p>Copiamos el proyecto <span class="codefrag">SWSeguroServicio</span> y lo pegamos con el nombre 
<span class="codefrag">SWSeguroServicioWar</span>. Editamos el <span class="codefrag">pom.xml</span> para actualizarle 
el groupId y el artifactId, y para indicarle que queremos el 
empaquetamiento de tipo war: 
</p>
<pre class="code"> 
 &lt;packaging&gt;war&lt;/packaging&gt;

</pre>
<p>Una vez hecho este cambio, debemos pulsar sobre el proyecto la opci&oacute;n 
Maven / Update project configuration.  Para generar el .war debemos 
pulsar sobre el proyecto, Run / Maven package. 
</p>
<div class="frame note">
<div class="label">Nota</div>
<div class="content">Nota: si la configuraci&oacute;n del proyecto no se ha actualizado 
correctamente y no se ha generado la estructura 
<span class="codefrag">WEB-INF</span> en <span class="codefrag">src/main/webapp</span>, se puede solucionar 
creando un nuevo proyecto Maven, indicando el arquetipo "webapp". 
Le a&ntilde;adimos al <span class="codefrag">pom.xml</span> las dependencias y plugins correspondientes, 
y copiamos los recursos y paquetes con clases al nuevo proyecto. 
Al ejecutar el proyecto como Maven package deber&iacute;a empaquetarlo 
en un archivo .war.
</div>
</div>
<p>Creamos una clase <span class="codefrag">ServletSeguro</span>, que herede de la clase 
<span class="codefrag">CXFNonSpringServlet</span> y que est&eacute; en el paquete 
<span class="codefrag">es.ua.jtech.seguro.servlet</span>. Podemos hacer caso a la sugerencia de 
a&ntilde;adir un <span class="codefrag">default serialVersionUID</span>, y con el bot&oacute;n derecho en la 
opci&oacute;n Source, hacemos click en Override methods y sobrecargamos 
el m&eacute;todo <span class="codefrag">loadBus</span> de la clase padre. Despu&eacute;s de la llamada al 
superconstructor, a&ntilde;adimos:
</p>
<pre class="code">
		org.apache.cxf.BusFactory.setDefaultBus(getBus());
		javax.xml.ws.Endpoint.publish("/p1", new SeguroImpl());
</pre>
<p>Configuramos el servlet en el descriptor <span class="codefrag">web.xml</span> que 
se encuentra en <span class="codefrag">src/main/webapp/WEB-INF</span>

</p>
<pre class="code"> 
&lt;!DOCTYPE web-app PUBLIC
 "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
 "http://java.sun.com/dtd/web-app_2_3.dtd" &gt;

&lt;web-app&gt;
  &lt;display-name&gt;Archetype Created Web Application&lt;/display-name&gt;
  &lt;servlet&gt;
  	&lt;servlet-name&gt;ServletSeguro&lt;/servlet-name&gt;
  	&lt;servlet-class&gt;es.ua.jtech.seguro.servlet.ServletSeguro&lt;/servlet-class&gt;
  &lt;/servlet&gt;
  &lt;servlet-mapping&gt;
  	&lt;servlet-name&gt;ServletSeguro&lt;/servlet-name&gt;
  	&lt;url-pattern&gt;/servicios/*&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;
&lt;/web-app&gt;

</pre>
<p>Generamos el .war y lo desplegamos en Tomcat. 
Ahora el cliente deber&iacute;a acceder al endpoint 
<a href="http://localhost:8080/SWSeguroWar/servicios/SeguroSOAP">http://localhost:8080/SWSeguroWar/servicios/SeguroSOAP</a> 
de donde tambi&eacute;n se puede obtener el WSDL a&ntilde;adiendo al endpoint "<span class="codefrag">?wsdl</span>".
</p>
</div> 

<p class="pageBreakAfter"></p>

<a name="N1010B"></a><a name="Ejercicios"></a>
<h2 class="underlined_10">Ejercicios</h2>
<div class="section">
<a name="N10110"></a><a name="Despliegue+de+la+calculadora+con+firma"></a>
<h3 class="underlined_5">Despliegue de la calculadora con firma</h3>
<p>En este ejercicio se debe desplegar en Tomcat la "Calculadora
con firma digital" de los ejercicios anteriores, tanto en su versi&oacute;n
con CXF, como en su versi&oacute;n con Axis2.</p>
</div>


<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2010 Depto. CCIA</div>
</div>
</body>
</html>
