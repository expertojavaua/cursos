<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Optimizaci&oacute;n de servicios web</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/cursos/sws"><img class="logoImage" alt="jtech" src="images/baner_j2ee_izq.gif" title="Especialista Universitario Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Servicios Web seguros" src="images/baner_j2ee_der.gif" title="Servicios Web seguros"></a>
</div>
<ul id="tabs">
<li class="current">
<a class="base-selected" href="index.html">Apuntes</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Servicios Web seguros</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Servicios Web seguros">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Sesiones</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesi&oacute;n 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesi&oacute;n 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesi&oacute;n 3</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesi&oacute;n 4</div>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesi&oacute;n 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesi&oacute;n 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesi&oacute;n 7</a>
</div>
<div class="menuitem">
<a href="sesion08-apuntes.html">Sesi&oacute;n 8</a>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html">Sesi&oacute;n 9</a>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html">Sesi&oacute;n 10</a>
</div>
<div class="menuitem">
<a href="sesion11-apuntes.html">Sesi&oacute;n 11</a>
</div>
<div class="menuitem">
<a href="sesion12-apuntes.html">Sesi&oacute;n 12</a>
</div>
<div class="menuitem">
<a href="roadmap-apuntes.html" title="Roadmap">Roadmap</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion04-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Optimizaci&oacute;n de servicios web</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Estructuras+de+datos+complejas">Estructuras de datos complejas</a>
<ul class="minitoc">
<li>
<a href="#Env%C3%ADo+de+excepciones+SOAP">Env&iacute;o de excepciones SOAP</a>
</li>
</ul>
</li>
<li>
<a href="#Mecanismo+de+optimizaci%C3%B3n+de+la+transmisi%C3%B3n+de+mensajes">Mecanismo de optimizaci&oacute;n de la transmisi&oacute;n de mensajes</a>
</li>
<li>
<a href="#Ejercicios">Ejercicios</a>
<ul class="minitoc">
<li>
<a href="#Tienda+de+DVDs">Tienda de DVDs</a>
</li>
</ul>
</li>
</ul>
</div>




<a name="N1000E"></a><a name="Estructuras+de+datos+complejas"></a>
<h2 class="underlined_10">Estructuras de datos complejas</h2>
<div class="section">
<p>En muchas ocasiones es necesario enviar cadenas de datos de diferentes 
longitudes, o estructuras que contienen distintos campos. Por ejemplo, 
cuando consultamos a una tienda una serie de productos, conviene hacer 
una &uacute;nica petici&oacute;n al servicio web, que incluya toda la lista de productos. 
Si por cada producto que queremos consultar, realiz&aacute;ramos una nueva petici&oacute;n 
al servicio web, la eficiencia se ver&iacute;a muy deteriorada. Para crear 
estructuras de datos complejas utilizaremos en el WSDL las etiquetas 
<span class="codefrag">&lt;xsd:complexType&gt;</span> y <span class="codefrag">&lt;xsd:sequence&gt;</span>, 
combinadas con <span class="codefrag">&lt;xsd:element&gt;</span>. En el siguiente ejemplo 
utilizaremos el editor gr&aacute;fico de WSDL de eclipse.
</p>
<p>Copiamos el proyecto <span class="codefrag">SWServicio</span> y lo pegamos como 
<span class="codefrag">ProductosServidor</span>. Cambiamos el nombre de 
<span class="codefrag">Servicio.wsdl</span> que se encuentra en <span class="codefrag">src/main/resources</span>, 
a <span class="codefrag">Productos.wsdl</span>. Lo editamos en modo XML y cambiamos todas 
las ocurrencias de la cadena "<span class="codefrag">Servicio</span>" por "<span class="codefrag">Productos</span>". 
Guardamos y editamos en modo visual. Cambiamos el nombre de la operaci&oacute;n 
"<span class="codefrag">saluda</span>" por "<span class="codefrag">obtenerPresupuesto</span>". Autom&aacute;ticamente 
se cambiar&aacute;n los nombres de los par&aacute;metros de entrada y de salida. A 
continuaci&oacute;n pinchamos en la flecha del primer par&aacute;metro, 
"<span class="codefrag">obtenerPresupuesto</span>", y se abre una nueva pesta&ntilde;a con 
"<span class="codefrag">(obtenerPresupuestoType)</span>", que contiene una secuencia de 
elementos: "<span class="codefrag">nombre</span>" y "<span class="codefrag">apellido</span>". Los eliminamos ambos. 
La secuencia queda vac&iacute;a y pulsando sobre ella con el bot&oacute;n derecho, 
a&ntilde;adimos un nuevo elemento y lo llamamos productosPedidos. 
Seleccionamos el tipo "New Type" y creamos un nuevo "Complex Type" con el 
nombre por defecto, "<span class="codefrag">productosPedidosType</span>". </p>
<p>
<img alt="Nuevo tipo productosPedidosType" content-width="10.19cm" src="imagenes/sws/33.png" width="700"></p>
<p>Aceptamos y pulsamos sobre "<span class="codefrag">productosPedidos</span>" con el bot&oacute;n 
derecho para cambiar la multiplicidad a 1 &oacute; m&aacute;s: Set Multiplicity / "1..*".  
A continuaci&oacute;n editamos el tipo "<span class="codefrag">(obtenerPresupuestoType)</span>" 
pulsando con doble click sobre &eacute;l, para entrar en una nueva pesta&ntilde;a que lo 
asocia con la definici&oacute;n del "<span class="codefrag">productosPedidosType</span>". 
Con el bot&oacute;n derecho sobre "<span class="codefrag">productosPedidosType</span>" a&ntilde;adimos 
una secuencia, y dentro de &eacute;sta a&ntilde;adimos dos nuevos elementos, uno de tipo 
<span class="codefrag">string</span>, llamado "<span class="codefrag">idProducto</span>", y otro de tipo 
<span class="codefrag">int</span> llamado "<span class="codefrag">cantidad</span>". </p>
<p>
<img alt="Elementos en productosPedidosType" content-width="10.19cm" src="imagenes/sws/34.png" width="700"></p>
<p>Guardamos y cerramos la pesta&ntilde;a, para volver a <span class="codefrag">Productos.wsdl</span>. 
Ahora pulsamos sobre la flecha que hay a la derecha del par&aacute;metro de entrada, 
"<span class="codefrag">obtenerPresupuestoResponse</span>". Eliminamos el &uacute;nico elemento que 
hay en la secuencia definida en el tipo, y a&ntilde;adimos uno nuevo a la secuencia, 
llamado "<span class="codefrag">productosRespuesta</span>", con un nuevo tipo, de tipo complejo 
y con el nombre por defecto, "<span class="codefrag">productosRespuestaType</span>".  
Hacemos doble click en "<span class="codefrag">(obtenerPresupuestoResponseType)</span>" para 
entrar en la pesta&ntilde;a de definici&oacute;n de ese tipo. 
En "<span class="codefrag">productosRespuestaType</span>" a&ntilde;adimos una nueva secuencia y a 
&eacute;sta le a&ntilde;adimos tres nuevos elementos: "<span class="codefrag">idProducto</span>", de tipo 
<span class="codefrag">string</span>, "<span class="codefrag">importe</span>", de tipo <span class="codefrag">double</span>, y 
"<span class="codefrag">foto</span>", de tipo <span class="codefrag">base64binary</span> (este &uacute;ltimo tipo 
est&aacute; disponible si pulsamos "Browse" para buscar el tipo, ya que no viene 
por defecto en la lista de tipos desplegable). 
</p>
<p>
<img alt="Elementos en productosRespuestaType" content-width="10.19cm" src="imagenes/sws/35.png" width="700"></p>
<p>Ahora podemos guardar y cerrar esta pesta&ntilde;a. Si editamos 
<span class="codefrag">Productos.wsdl</span> en modo XML, &eacute;ste consiste en:</p>
<pre class="code"> 
&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;
&lt;wsdl:definitions xmlns:soap="http://schemas.xmlsoap.org/wsdl/soap/" 
xmlns:tns="http://jtech.ua.es/Productos/" 
xmlns:wsdl="http://schemas.xmlsoap.org/wsdl/" 
xmlns:xsd="http://www.w3.org/2001/XMLSchema" 
name="Productos" targetNamespace="http://jtech.ua.es/Productos/"&gt;
  &lt;wsdl:types&gt;
    &lt;xsd:schema targetNamespace="http://jtech.ua.es/Productos/"&gt;
      &lt;xsd:element name="obtenerPresupuesto"&gt;
        &lt;xsd:complexType&gt;
          &lt;xsd:sequence&gt;
          	&lt;xsd:element name="productosPedidos" 
          	     type="tns:productosPedidosType" 
          	     maxOccurs="unbounded" minOccurs="1" /&gt;
          &lt;/xsd:sequence&gt;
        &lt;/xsd:complexType&gt;
      &lt;/xsd:element&gt;
      &lt;xsd:element name="obtenerPresupuestoResponse"&gt;
        &lt;xsd:complexType&gt;
          &lt;xsd:sequence&gt;
          	&lt;xsd:element name="productosRespuesta" 
          	             type="tns:productosRespuestaType" 
          	             maxOccurs="unbounded" minOccurs="1" /&gt;
          &lt;/xsd:sequence&gt;
        &lt;/xsd:complexType&gt;
      &lt;/xsd:element&gt;
    
      &lt;xsd:complexType name="productosPedidosType"&gt;
      	&lt;xsd:sequence&gt;
      		&lt;xsd:element name="idProducto" type="xsd:string" /&gt;
      		&lt;xsd:element name="cantidad" type="xsd:int" /&gt;
      	&lt;/xsd:sequence&gt;
      &lt;/xsd:complexType&gt;
    
      &lt;xsd:complexType name="productosRespuestaType"&gt;
      	&lt;xsd:sequence&gt;
      		&lt;xsd:element name="idProducto" type="xsd:string" /&gt;
      		&lt;xsd:element name="importe" type="xsd:double" /&gt;
      		&lt;xsd:element name="foto" type="xsd:base64Binary" /&gt;
      	&lt;/xsd:sequence&gt;
      &lt;/xsd:complexType&gt;
    &lt;/xsd:schema&gt;
  &lt;/wsdl:types&gt;
  &lt;wsdl:message name="obtenerPresupuestoRequest"&gt;
    &lt;wsdl:part element="tns:obtenerPresupuesto" 
               name="parameters"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:message name="obtenerPresupuestoResponse"&gt;
    &lt;wsdl:part element="tns:obtenerPresupuestoResponse" 
               name="parameters"/&gt;
  &lt;/wsdl:message&gt;
  &lt;wsdl:portType name="Productos"&gt;
    &lt;wsdl:operation name="obtenerPresupuesto"&gt;
      &lt;wsdl:input message="tns:obtenerPresupuestoRequest"/&gt;
      &lt;wsdl:output message="tns:obtenerPresupuestoResponse"/&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:portType&gt;
  &lt;wsdl:binding name="ProductosSOAP" type="tns:Productos"&gt;
    &lt;soap:binding style="document" 
                  transport="http://schemas.xmlsoap.org/soap/http"/&gt;
    &lt;wsdl:operation name="obtenerPresupuesto"&gt;
      &lt;soap:operation 
        soapAction="http://jtech.ua.es/Productos/obtenerPresupuesto"/&gt;
      &lt;wsdl:input&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:input&gt;
      &lt;wsdl:output&gt;
        &lt;soap:body use="literal"/&gt;
      &lt;/wsdl:output&gt;
    &lt;/wsdl:operation&gt;
  &lt;/wsdl:binding&gt;
  &lt;wsdl:service name="Productos"&gt;
    &lt;wsdl:port binding="tns:ProductosSOAP" name="ProductosSOAP"&gt;
      &lt;soap:address location="http://localhost:8080/"/&gt;
    &lt;/wsdl:port&gt;
  &lt;/wsdl:service&gt;
&lt;/wsdl:definitions&gt;

</pre>
<p>Ahora podemos eliminar el <span class="codefrag">paquete es.ua.jtech.servicio</span> y 
editar el <span class="codefrag">GeneraCodigo.java</span> para que la llamada al generador 
lea el nuevo documento WSDL: 
</p>
<pre class="code">
		WSDLToJava.main(new String[]{
				"-server",
				"-d","src/main/java",
				"src/main/resources/Productos.wsdl" });
</pre>
<p>Generamos el c&oacute;digo y pulsamos Refresh. Movemos el servidor generado en 
<span class="codefrag">Productos_ProductosSOAP_Server.java</span> a un nuevo paquete, 
"<span class="codefrag">es.ua.jtech.productos.custom</span>", porque lo vamos a modificar 
y no queremos que se confunda con el c&oacute;digo autogenerado. Para moverlo 
podemos utilizar la opci&oacute;n Refactor / Move / Create Package... y a&ntilde;adimos 
"<span class="codefrag">.custom</span>" al paquete en el que ya estaba. Aceptamos y el 
.java aparece en el nuevo paquete. Ahora lo editamos para corregir el 
error que presenta. Pulsamos sobre las sugerencias para reparar el error 
y seleccionamos la primera, que es la de crear una nueva clase llamada 
<span class="codefrag">ProductosImpl</span>. En el asistente de creaci&oacute;n de la clase 
a&ntilde;adimos la implementaci&oacute;n de la interfaz "<span class="codefrag">Productos</span>", dejamos 
que el paquete donde se genere sea tambi&eacute;n el custom y pulsamos Finish. </p>
<p>Aparece la sobrecarga del m&eacute;todo <span class="codefrag">obtenerPresupuesto</span>. Debemos 
introducir la creaci&oacute;n de una nueva lista de productos de respuesta. 
Para ello recorreremos uno a uno los productos de la lista 
<span class="codefrag">productosPedidos</span> y crearemos un nuevo <span class="codefrag">ProductosRespuestaType</span> 
con un <span class="codefrag">idProducto</span>, <span class="codefrag">foto</span> e <span class="codefrag">importe</span>, 
seg&uacute;n el producto y la cantidad que tengamos en el 
<span class="codefrag">ProductosPedidosType</span>. En cada iteraci&oacute;n a&ntilde;adiremos ese nuevo 
<span class="codefrag">ProductosRespuestaType</span> a la lista que hemos creado al 
principio del m&eacute;todo, y al finalizar el bucle devolveremos dicha lista.</p>
<pre class="code"> 
		List&lt;ProductosRespuestaType&gt; prs = 
		  new ArrayList&lt;ProductosRespuestaType&gt;();
		for(ProductosPedidosType prPedido : productosPedidos){
			ProductosRespuestaType pr = new ProductosRespuestaType();
			pr.setIdProducto(prPedido.getIdProducto());
			pr.setImporte( ... );
			pr.setFoto( ... );
			prs.add(pr);
		}
		return prs;
</pre>
<p>Lo normal ser&iacute;a que el servidor hiciera una consulta a una base de datos. 
En este ejemplo vamos a introducir los productos directamente en el c&oacute;digo. 
Vamos a tener en cuenta el producto "<span class="codefrag">Calculadora</span>" y el producto 
"<span class="codefrag">Pila</span>". Para devolver la imagen del producto al cliente, 
vamos a descargar dos fotos arbitrarias en formato JPG, y las guardaremos 
como <span class="codefrag">src/main/resources/fotos/calc.jpg</span> y 
<span class="codefrag">src/main/resouces/fotos/pila.jpg</span> en el proyecto 
<span class="codefrag">ProductosCliente</span>. Una vez implementada la l&oacute;gica de la operaci&oacute;n, 
incluyendo la lectura de la imagen y su conversi&oacute;n a cadena de bytes, el 
c&oacute;digo queda as&iacute;:
</p>
<pre class="code"> 
package es.ua.jtech.productos.custom;

import java.io.ByteArrayOutputStream;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import es.ua.jtech.productos.Productos;
import es.ua.jtech.productos.ProductosPedidosType;
import es.ua.jtech.productos.ProductosRespuestaType;

public class ProductosImpl implements Productos {

	@Override
	public List&lt;ProductosRespuestaType&gt; obtenerPresupuesto(
			List&lt;ProductosPedidosType&gt; productosPedidos) {

		List&lt;ProductosRespuestaType&gt; prs = 
		  new ArrayList&lt;ProductosRespuestaType&gt;();
		for(ProductosPedidosType prPedido : productosPedidos){
			ProductosRespuestaType pr = 
			  new ProductosRespuestaType();
			pr.setIdProducto(prPedido.getIdProducto());

			FileInputStream fis = null;
			if(prPedido.getIdProducto().toLowerCase()
			      .equals("calculadora")){
				pr.setImporte(prPedido.getCantidad()*10);
				try {
					fis = new FileInputStream(
					  "src/main/resources/fotos/calc.jpg");
				} catch (FileNotFoundException e) {
					e.printStackTrace();
					fis = null;
				}
			}else if(prPedido.getIdProducto().toLowerCase()
			      .equals("pila")){
				pr.setImporte(((double)prPedido.getCantidad())*0.60);
				try {
					fis = new FileInputStream(
					  "src/main/resources/fotos/pila.jpg");
				} catch (FileNotFoundException e) {
					e.printStackTrace();
					fis = null;
				}
			}else{
				pr.setImporte(-1);
				fis = null;
			}
			if(fis == null){
				pr.setFoto(null);
			}else{
				ByteArrayOutputStream baos = 
				  new ByteArrayOutputStream();
				byte[] buffer = new byte[1024];
				try {
					int nbytes;
					while(true){
						if((nbytes=fis.read(buffer)) == -1){
							break;
						}
							baos.write(buffer,0,nbytes);
					}
					pr.setFoto(baos.toByteArray());
				} catch (IOException e) {
					e.printStackTrace();
					pr.setFoto(null);
				}
			}
			
			prs.add(pr);
		}
		return prs;
	}

}

</pre>
<p>Con esto tenemos terminado el servidor del servicio web. 
Implementar el cliente es tan s&oacute;lo cuesti&oacute;n de generar el c&oacute;digo e 
introducir unos productos de prueba para comprobar que la llamada funciona. 
Copiamos el proyecto <span class="codefrag">SWCliente</span> como un nuevo proyecto llamado 
<span class="codefrag">ProductosCliente</span>. Eliminamos el paquete 
<span class="codefrag">es.ua.jtech.servicio</span> y eliminamos <span class="codefrag">Servicio.wsdl</span>. 
Copiamos en su lugar el nuevo, <span class="codefrag">Productos.wsdl</span> y cambiamos el 
nombre del WSDL en <span class="codefrag">GeneraCodigo.java</span>. Generamos el c&oacute;digo y 
refrescamos. Movemos con el Refactor la clase 
<span class="codefrag">Productos_ProductosSOAP_Client</span> a un nuevo paquete 
<span class="codefrag">es.ua.jtech.productos.custom</span> y la editamos para introducir 
productos. Una vez realizada la llamada con la lista de productos y sus 
cantidades correspondientes, obtenemos una lista de productos de respuesta. 
La recorremos y mostramos sus importes, y sus identificadores, mientras 
que sus im&aacute;genes las guardamos en disco con un nuevo nombre que depende 
del identificador, y tambi&eacute;n utilizamos el un comando externo para mostrar 
las im&aacute;genes, en este ejemplo, la aplicaci&oacute;n <span class="codefrag">Eye of Gnome</span>. 
La parte de la llamada del programa cliente podr&iacute;a ser algo as&iacute;:
</p>
<pre class="code"> 
        {
            System.out.println("Invoking preguntaPrecios...");
            
            java.util.List&lt;ProductosPedidosType&gt; items = 
              new ArrayList&lt;ProductosPedidosType&gt;();
            ProductosPedidosType item;
            item = new ProductosPedidosType();
            item.setIdProducto("Calculadora");
            item.setCantidad(5);
            items.add(item);
            item = new ProductosPedidosType();
            item.setIdProducto("Pila");
            item.setCantidad(20);
            items.add(item);
            item = new ProductosPedidosType();
            item.setIdProducto("Domo Kun");
            item.setCantidad(2);
            items.add(item);
            
            java.util.List&lt;ProductosRespuestaType&gt; _preguntaPrecios__return 
              = port.obtenerPresupuesto(items);

            for(ProductosRespuestaType pr:_preguntaPrecios__return){
            	System.out.println(pr.getIdProducto()+", total = "
                  + pr.getImporte());
            	if(pr.getFoto()!=null){
    	        	try{
    	        		String filename = pr.getIdProducto()+".jpg";
    	        		FileOutputStream fos = 
    	        		  new FileOutputStream(filename);
    	        		fos.write(pr.getFoto());
    	        		fos.close();
    	        		//Ejecutar el visor Eye of Gnome
    	        		Runtime.getRuntime().exec("eog -n "+filename);
    	        	}catch(IOException e){
    	        		System.out.println("Error escribiendo la imagen: " 
    	        		  + pr.getIdProducto());
    	        	}
    	        }
            }

        }

</pre>
<div class="frame note">
<div class="label">Nota</div>
<div class="content">
Nota: las im&aacute;genes se guardan en la ra&iacute;z del proyecto cliente, pero 
en Eclipse no se ver&aacute;n hasta que no se pulse Refresh. 
</div>
</div>
<p>Ejecutamos el servidor y a cuando haya arrancado ejecutamos el cliente. 
El resultado es:</p>
<p>
<img alt="Respuesta devuelta por preguntaPrecios" content-width="11.44cm" src="imagenes/sws/36.png" width="700"></p>
<a name="N10131"></a><a name="Env%C3%ADo+de+excepciones+SOAP"></a>
<h3 class="underlined_5">Env&iacute;o de excepciones SOAP</h3>
<p>En el anterior ejemplo hemos indicado con un "-1" que el producto 
Domo Kun no existe en la lista de productos. Esto no es una buena 
pr&aacute;ctica de programaci&oacute;n, ya que podr&iacute;a darse el caso de que el importe 
realmente consistiese en devolver un euro. Adem&aacute;s, "-1" no es un error 
explicativo, y si hubiera varias causas posibles no podr&iacute;a especificarse 
f&aacute;cilmente cu&aacute;l de ellas ha sido. En estos casos conviene utilizar 
excepciones y enviarlas en los mensajes SOAP. 
</p>
<p>Vamos a editar el 
<span class="codefrag">Productos.wsdl</span> de <span class="codefrag">ProductosServidor</span> y, en el modo 
de dise&ntilde;o, pulsamos sobre la operaci&oacute;n "<span class="codefrag">obtenerPresupuesto</span>" y 
seleccionamos "Add Fault". Aparece un nuevo par&aacute;metro <span class="codefrag">fault</span>, 
con el elemento <span class="codefrag">obtenerPresupuestoFault</span>. Para asegurarnos de que 
el binding de los datos es el correcto, hacemos click sobre el cuadrado 
peque&ntilde;o que uno el servicio con el interfaz a trav&eacute;s de flechas. &Eacute;ste 
representa el binding. Con el bot&oacute;n derecho pulsamos a Generate Binding 
Content... y marcamos la casilla Overwrite existing binding information, 
dejando el resto por defecto y pulsamos Finish.</p>
<p>
<img alt="Volver a generar el Binding" content-width="10.19cm" src="imagenes/sws/37.png" width="700"></p>
<p>Guardamos el WSDL y lo sobreescribimos en el proyecto <span class="codefrag">ProductosCliente</span> 
para que sea el mismo. En ambos eliminamos los paquetes 
<span class="codefrag">es.ua.jtech.productos</span> y volvemos a generar sus c&oacute;digos. 
Podemos eliminar del cliente la nueva clase cliente generada, 
pues ya tenemos la nuestra en el paquete custom, y as&iacute; mismo eliminamos el 
nuevo servidor generado, que viene marcado por un error. </p>
<p>Para lanzar la excepci&oacute;n vamos a editar 
<span class="codefrag">es.ua.jtech.productos.custom.ProductosImpl</span> y en el caso del 
producto no existente, lanzamos una nueva 
<span class="codefrag">ObtenerPresupuestoFault_Exception</span> (que est&aacute; definida en el 
c&oacute;digo reci&eacute;n generado):
</p>
<pre class="code">
			}else{
				pr.setImporte(-1);
				fis = null;
				throw new ObtenerPresupuestoFault_Exception(
				  "No existe el producto "+prPedido.getIdProducto());
			}
</pre>
<p>El entorno marcar&aacute; esa l&iacute;nea como err&oacute;nea y nos sugerir&aacute; a&ntilde;adir la 
cl&aacute;usula throw a la definici&oacute;n del m&eacute;todo como primera opci&oacute;n, y es la 
que debemos seleccionar. Este throw lo podemos declarar porque la nueva 
interfaz <span class="codefrag">Productos</span> as&iacute; lo especifica.</p>
<p>Con esto el servidor est&aacute; listo. Lo arrancamos y a continuaci&oacute;n 
ejecutamos el cliente. La salida es:</p>
<pre class="code">
Invoking preguntaPrecios...
Exception in thread "main" javax.xml.ws.soap.SOAPFaultException: 
                                  No existe el producto Domo Kun
	at org.apache.cxf.jaxws.JaxWsClientProxy.invoke(
	                                  JaxWsClientProxy.java:146)
	at $Proxy40.obtenerPresupuesto(Unknown Source)
	at es.ua.jtech.productos.custom.Productos_ProductosSOAP_Client.
	                 main(Productos_ProductosSOAP_Client.java:80)
Caused by: org.apache.cxf.binding.soap.SoapFault: 
                                  No existe el producto Domo Kun
[...]
</pre>
<p>Es decir, nuestra llamada al servicio web efectivamente ha lanzado 
la excepci&oacute;n y no la hemos capturado. Para capturarla sobra con a&ntilde;adir 
un try/catch en el cliente:
</p>
<pre class="code"> 
      try{
      	java.util.List&lt;ProductosRespuestaType&gt; _preguntaPrecios__return 
      	 = port.obtenerPresupuesto(items);
       for(ProductosRespuestaType pr:_preguntaPrecios__return){

[...]

       }
      }catch(SOAPFaultException e){
      	System.out.println("Error: " + e.getMessage()+
      	         ". Llamada al servicio web abortada.");
      }

</pre>
<div class="frame note">
<div class="label">Nota</div>
<div class="content">
Nota: La excepci&oacute;n aborta la llamada entera y no es apropiada en 
caso de que el resto de la informaci&oacute;n del mensaje SOAP siga siendo 
v&aacute;lida y deba procesarse.
</div>
</div>
<p>Finalmente comentamos la l&iacute;nea del servidor que lanza la excepci&oacute;n, 
para que el ejemplo siga funcionando correctamente, ya que lo vamos 
a utilizar a continuaci&oacute;n.</p>
<pre class="code">//throw new ObtenerPresupuestoFault_Exception(
       "No existe el producto "+prPedido.getIdProducto());
</pre>
</div> 


<a name="N1018B"></a><a name="Mecanismo+de+optimizaci%C3%B3n+de+la+transmisi%C3%B3n+de+mensajes"></a>
<h2 class="underlined_10">Mecanismo de optimizaci&oacute;n de la transmisi&oacute;n de mensajes</h2>
<div class="section">
<p>Para que los archivos se transmitan de forma eficiente hay que 
utilizar el mecanismo de optimizaci&oacute;n de la transmisi&oacute;n de mensajes, MTOM. 
Tanto CXF como Axis2 lo soportan, pero hay que activarlo tanto en el 
cliente, como en el servidor. Tambi&eacute;n vamos a indicar el tipo mime en el WSDL.
</p>
<div class="frame note">
<div class="label">Nota</div>
<div class="content">Nota: En este punto podemos hacer una copia de los proyectos 
ProductosCliente y ProductosServidor para quedarse tambi&eacute;n con 
la versi&oacute;n sin MTOM y luego ver la diferencia.
</div>
</div>
<p>Editamos <span class="codefrag">Productos.wsdl</span> y a&ntilde;adimos a los espacios 
de nombres de la primera etiqueta:
</p>
<pre class="code">xmlns:xmime="http://www.w3.org/2005/05/xmlmime"</pre>
<p>Ahora podemos a&ntilde;adir el tipo mime a la foto:</p>
<pre class="code"> 
      		&lt;xsd:element name="foto" type="xsd:base64Binary" 
      		 xmime:expectedContentTypes="application/octet-stream"/&gt;

</pre>
<p>Guardamos el WSDL y lo copiamos al otro proyecto para que sea el mismo en 
<span class="codefrag">ProductosCliente</span> y en <span class="codefrag">ProductosServidor</span>. Eliminamos 
los paquetes <span class="codefrag">es.ua.jtech.productos</span> de ambos proyectos y volvemos 
a generar el c&oacute;digo. En el servidor eliminamos la nueva clase servidor que 
se ha generado, porque tenemos la nuestra en el paquete <span class="codefrag">custom</span>. 
Nuestra implementaci&oacute;n <span class="codefrag">ProductosImpl.java</span> da un error. Se debe a 
que el m&eacute;todo <span class="codefrag">setFoto</span> ya no acepta como par&aacute;metro una cadena de 
bytes sino un <span class="codefrag">DataHandler</span>, clase que gestiona de forma eficiente 
los streams de entrada: sin cargarlos enteros en memoria, sino carg&aacute;ndolos 
bajo demanda. As&iacute; pues, ya no vamos a utilizar el buffer de bytes ni el 
<span class="codefrag">FileInputStream</span>, sino que vamos a utilizar un <span class="codefrag">DataSource</span>. 
El c&oacute;digo se simplifica un poco, al no tener que cargar datos por 
medio de un buffer. Tambi&eacute;n desaparecen los try/catch:
</p>
<pre class="code"> 
	@Override
	public List&lt;ProductosRespuestaType&gt; obtenerPresupuesto(
			List&lt;ProductosPedidosType&gt; productosPedidos) 
			throws ObtenerPresupuestoFault_Exception {

		List&lt;ProductosRespuestaType&gt; prs = 
		  new ArrayList&lt;ProductosRespuestaType&gt;();
		for(ProductosPedidosType prPedido : productosPedidos){
			ProductosRespuestaType pr = new ProductosRespuestaType();
			pr.setIdProducto(prPedido.getIdProducto());

			DataHandler dh = null;
			if(prPedido.getIdProducto().toLowerCase().
			  equals("calculadora")){
				pr.setImporte(prPedido.getCantidad()*10);
				dh = new DataHandler(new FileDataSource(
				  "src/main/resources/fotos/calc.jpg"));
			}else if(prPedido.getIdProducto().toLowerCase().
			   equals("pila")){
				pr.setImporte(((double)prPedido.getCantidad())*0.60);
				dh = new DataHandler(new FileDataSource(
				  "src/main/resources/fotos/pila.jpg"));
			}else{
				pr.setImporte(-1);
				dh = null;
				//throw new ObtenerPresupuestoFault_Exception(
				  "No existe el producto "+prPedido.getIdProducto());
			}
			pr.setFoto(dh);
			prs.add(pr);
		}
		return prs;
	}

</pre>
<p>Con estos cambios el error desaparece, pero todav&iacute;a hay que activar 
de manera expl&iacute;cita MTOM en el servidor. Editamos 
<span class="codefrag">es.ua.jtech.productos.custom.Productos_ProductosSOAP_Server</span> 
y cambiamos su constructor:</p>
<pre class="code">
    protected Productos_ProductosSOAP_Server() throws Exception {
        System.out.println("Starting Server");
        Object implementor = new ProductosImpl();
        String address = "http://localhost:8080/";
        Endpoint endpoint = Endpoint.publish(address, implementor);
        SOAPBinding binding = (SOAPBinding)endpoint.getBinding();
        binding.setMTOMEnabled(true);
    }
</pre>
<p>donde <span class="codefrag">SOAPBinding</span> pertenece al paquete 
<span class="codefrag">javax.xml.ws.soap</span>.</p>
<p>Hemos terminado con la parte del servidor y ahora vamos a 
arreglar el cliente. Eliminamos la clase 
<span class="codefrag">Productos_ProductosSOAP_Client.java</span> del paquete 
<span class="codefrag">productos</span> y editamos la del paquete <span class="codefrag">custom</span>, 
que da un error en la l&iacute;nea:</p>
<pre class="code">fos.write(pr.getFoto());</pre>
<p>La cambiamos por:</p>
<pre class="code">pr.getFoto().writeTo(fos);</pre>
<p>lo cual soluciona el error, y ahora s&oacute;lo falta activar MTOM. 
Despu&eacute;s de la creaci&oacute;n del puerto,
</p>
<pre class="code">Productos port = ss.getProductosSOAP();</pre>
<p>a&ntilde;adimos las l&iacute;neas:</p>
<pre class="code">
        SOAPBinding binding = (SOAPBinding)((BindingProvider)port).getBinding(); 
        binding.setMTOMEnabled(true); 
</pre>
<p>donde <span class="codefrag">SOAPBinding</span> pertenece al paquete 
<span class="codefrag">javax.xml.ws.soap</span> y <span class="codefrag">BindingProvider</span> pertenece a 
<span class="codefrag">javas.xml.ws</span>.  Ya podemos ejecutar el cliente, no sin antes 
ejecutar el servidor y esperar a que arranque. El resultado debe ser el 
mismo que antes de usar MTOM, pero los mensajes SOAP habr&aacute;n cambiado. 
Util&iacute;cese el TCP Monitor para ver la diferencia.</p>
<p>En Axis2 la generaci&oacute;n del servicio es igual que se ha explicado en las 
secciones anteriores. Podemos copiar los proyectos 
<span class="codefrag">Axis2SWCliente</span> y <span class="codefrag">Axis2SWServicio</span> 
como <span class="codefrag">Axis2ProductosCliente</span> y <span class="codefrag">Axis2ProductosServidor</span>, 
respectivamente. Eliminamos los paquete autogenerados y el antiguo WSDL, 
copiando en su lugar <span class="codefrag">Productos.wsdl</span>. 
Modificamos <span class="codefrag">GeneraCodigo.java</span> con el nuevo nombre del WSDL 
y generamos y refrescamos en ambos proyectos. En el servidor modificamos la 
clase <span class="codefrag">ProductosSkeleton</span> para introducir la operaci&oacute;n del 
servicio, y a&ntilde;adimos la carpeta con las im&aacute;genes. Para activar MTOM en el 
servicio editamos el archivo generado 
<span class="codefrag">src/main/resources/META-INF/services.xml</span> y en la secci&oacute;n 
donde se a&ntilde;aden par&aacute;metros al servicio a&ntilde;adimos:</p>
<pre class="code"> &lt;parameter name="enableMTOM"&gt;true&lt;/parameter&gt;</pre>
<p>La activaci&oacute;n de MTOM en el cliente se har&iacute;a con: </p>
<pre class="code"> 
ProductosStub stub = new ProductosStub(
  "http://localhost:8080/axis2/services/Productos");
stub._getServiceClient().getOptions().setProperty(
  Constants.Configuration.ENABLE_MTOM, "true");
stub.obtenerPresupuesto( ... );

</pre>
</div> 


<p class="pageBreakAfter"></p>



<a name="N1023D"></a><a name="Ejercicios"></a>
<h2 class="underlined_10">Ejercicios</h2>
<div class="section">
<a name="N10243"></a><a name="Tienda+de+DVDs"></a>
<h3 class="underlined_5">Tienda de DVDs</h3>
<p>
  Nuestro negocio consiste en una tienda que 
  vende pel&iacute;culas en DVD a trav&eacute;s de Internet. Para dar una mayor 
  difusi&oacute;n a nuestro cat&aacute;logo de pel&iacute;culas, decidimos implantar 
  una serie de Servicios Web para acceder a informaci&oacute;n sobre las pel&iacute;culas 
  que vendemos.</p>
<p>De cada pel&iacute;cula ofreceremos informaci&oacute;n sobre su t&iacute;tulo, 
  su director y su precio. Esta informaci&oacute;n podemos codificarla en una 
  clase <span class="codefrag">PeliculaTO</span> como la siguiente:</p>
<pre class="code">public class <strong>PeliculaTO</strong> {
  private String titulo;
  private String director;
  private float precio;
   
  public PeliculaTO() {}
   
  public PeliculaTO(String titulo, String director, float precio) {
    this.titulo = titulo;
    this.director = director;
    this.precio = precio;
  }

  // Getters y setters
  ...
}</pre>
<p>Vamos a permitir que se busquen pel&iacute;culas proporcionando el nombre de 
  su director. Por lo tanto, el servicio ofrecer&aacute; una operaci&oacute;n 
  como la siguiente:</p>
<pre class="code">List&lt;PeliculaTO&gt; <strong>buscaDirector</strong>(String director)</pre>
<p>Proporcionaremos el nombre del director, y nos devolver&aacute; la lista de 
  pel&iacute;culas disponibles dirigidas por este director.</p>
<p>En un principio, podemos crear una lista est&aacute;tica de pel&iacute;culas 
  dentro del c&oacute;digo de nuestro servicio, como por ejemplo:</p>
<pre class="code">final static PeliculaTO[] peliculas = {
    new PeliculaTO("Mulholland Drive", "David Lynch", 26.96f),
    new PeliculaTO("Carretera perdida", "David Lynch", 18.95f),
    new PeliculaTO("Twin Peaks", "David Lynch", 46.95f),
    new PeliculaTO("Telefono rojo", "Stanley Kubrick", 15.95f),
    new PeliculaTO("Barry Lyndon", "Stanley Kubrick", 24.95f),
    new PeliculaTO("La naranja mec&aacute;nica", "Stanley Kubrick", 22.95f) 
};</pre>
<p>Se pide:</p>
<p>
  
<em>a)</em> Implementar el servicio. El servicio se llamar&aacute; 
  <span class="codefrag">TiendaDvdSW</span>, y estar&aacute; dentro de un proyecto con nombre 
  <span class="codefrag">DVDServicio</span>.
  </p>
<p>Para construir una lista con las pel&iacute;culas cuyo director coincida con 
  el nombre del director que se ha solicitado, podemos utilizar un c&oacute;digo 
  similar al siguiente, donde se ha proporcionado un par&aacute;metro <span class="codefrag">director</span>:</p>
<pre class="code">director = director.toLowerCase();
   
ArrayList&lt;PeliculaTO&gt; list = new ArrayList&lt;PeliculaTO&gt;();
   
for (PeliculaTO pelicula : peliculas) {
  if (pelicula.getDirector().toLowerCase().indexOf(director) != -1) {
    list.add(pelicula);
  }
}
      
return list;</pre>
<p>
<em>c)</em> Implementar un cliente Java que acceda a dicho servicio. El cliente deber&aacute; crearse
en un proyecto <span class="codefrag">DVDCliente</span>.</p>
</div>




<p class="pageBreakAfter"></p>

</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2010 Depto. CCIA</div>
</div>
</body>
</html>
