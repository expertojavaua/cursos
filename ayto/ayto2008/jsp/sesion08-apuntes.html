<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta content="Apache Forrest" name="Generator">
<meta name="Forrest-version" content="0.7">
<meta name="Forrest-skin-name" content="pelt">
<title>Creaci&oacute;n de tags propias</title>
<link type="text/css" href="skin/basic.css" rel="stylesheet">
<link media="screen" type="text/css" href="skin/screen.css" rel="stylesheet">
<link media="print" type="text/css" href="skin/print.css" rel="stylesheet">
<link type="text/css" href="skin/profile.css" rel="stylesheet">
<script src="skin/getBlank.js" language="javascript" type="text/javascript"></script><script src="skin/getMenu.js" language="javascript" type="text/javascript"></script><script src="skin/fontsize.js" language="javascript" type="text/javascript"></script>
<link rel="shortcut icon" href="">
</head>
<body onload="init()">
<script type="text/javascript">ndeSetTextSize();</script>
<div id="top">
<div class="header">
<div class="grouplogo">
<a href="http://www.jtech.ua.es/j2ee"><img class="logoImage" alt="jtech" src="images/baner_j2ee_izq.gif" title="Especialista Universitario Java Enterprise"></a>
</div>
<div class="projectlogoA1">
<a href="http://www.dccia.ua.es/"><img class="logoImage" alt="Componentes Web" src="images/baner_j2ee_der.gif" title="Componentes Web"></a>
</div>
<ul id="tabs">
<li>
<a class="base-not-selected" href="javascript:location.href='../index.html'">Home</a>
</li>
<li>
<a class="base-not-selected" href="javascript:location.href='../proy-int/index.html'">Proyecto SIGEM</a>
</li>
<li class="current">
<a class="base-selected" href="index.html">Componentes Web</a>
</li>
</ul>
</div>
</div>
<div id="main">
<div id="publishedStrip">
<div id="level2tabs"></div>
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="breadtrail">
             
             &nbsp;
           </div>
<div id="menu">
<div onclick="SwitchMenu('menu_selected_1.1', 'skin/')" id="menu_selected_1.1Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Componentes Web</div>
<div id="menu_selected_1.1" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="index.html" title="Componentes Web">&Iacute;ndice</a>
</div>
<div onclick="SwitchMenu('menu_selected_1.1.2', 'skin/')" id="menu_selected_1.1.2Title" class="menutitle" style="background-image: url('skin/images/chapter_open.gif');">Teor&iacute;a</div>
<div id="menu_selected_1.1.2" class="selectedmenuitemgroup" style="display: block;">
<div class="menuitem">
<a href="sesion01-apuntes.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-apuntes.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-apuntes.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-apuntes.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-apuntes.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-apuntes.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-apuntes.html">Sesion 7</a>
</div>
<div class="menupage">
<div class="menupagetitle">Sesion 8</div>
</div>
<div class="menuitem">
<a href="sesion09-apuntes.html">Sesion 9</a>
</div>
<div class="menuitem">
<a href="sesion10-apuntes.html">Sesion 10</a>
</div>
<div class="menuitem">
<a href="roadmap-apuntes.html">Roadmap</a>
</div>
</div>
<div onclick="SwitchMenu('menu_1.1.3', 'skin/')" id="menu_1.1.3Title" class="menutitle">Ejercicios</div>
<div id="menu_1.1.3" class="menuitemgroup">
<div class="menuitem">
<a href="sesion01-ejercicios.html">Sesion 1</a>
</div>
<div class="menuitem">
<a href="sesion02-ejercicios.html">Sesion 2</a>
</div>
<div class="menuitem">
<a href="sesion03-ejercicios.html">Sesion 3</a>
</div>
<div class="menuitem">
<a href="sesion04-ejercicios.html">Sesion 4</a>
</div>
<div class="menuitem">
<a href="sesion05-ejercicios.html">Sesion 5</a>
</div>
<div class="menuitem">
<a href="sesion06-ejercicios.html">Sesion 6</a>
</div>
<div class="menuitem">
<a href="sesion07-ejercicios.html">Sesion 7</a>
</div>
<div class="menuitem">
<a href="sesion08-ejercicios.html">Sesion 8</a>
</div>
<div class="menuitem">
<a href="sesion09-ejercicios.html">Sesion 9</a>
</div>
<div class="menuitem">
<a href="sesion10-ejercicios.html">Sesion 10</a>
</div>
</div>
</div>
<div id="credit"></div>
<div id="roundbottom">
<img style="display: none" class="corner" height="15" width="15" alt="" src="skin/images/rc-b-l-15-1body-2menu-3menu.png"></div>
<div id="credit2"></div>
</div>
<div id="content">
<div title="Portable Document Format" class="pdflink">
<a class="dida" href="sesion08-apuntes.pdf"><img alt="PDF -icon" src="skin/images/pdfdoc.gif" class="skin"><br>
        PDF</a>
</div>
<h1>Creaci&oacute;n de tags propias</h1>
<div id="minitoc-area">
<ul class="minitoc">
<li>
<a href="#Tag+files">Tag files</a>
<ul class="minitoc">
<li>
<a href="#Paso+de+par%C3%A1metros">Paso de par&aacute;metros </a>
</li>
<li>
<a href="#Etiquetas+con+contenido">Etiquetas con contenido</a>
</li>
</ul>
</li>
<li>
<a href="#Simple+tags">Simple tags</a>
<ul class="minitoc">
<li>
<a href="#Clase+Java+para+implementar+el+tag">Clase Java para implementar el tag</a>
</li>
<li>
<a href="#Descriptor+de+despliegue+%28.tld%29">Descriptor de despliegue (.tld)</a>
</li>
<li>
<a href="#simple+tags+con+atributos">simple tags con atributos</a>
</li>
</ul>
</li>
</ul>
</div>

<p>Como hemos visto en JSTL, las librer&iacute;as de tags encapsulan funcionalidad Java en los JSP sin necesidad
de insertar c&oacute;digo. Podr&iacute;a ser &uacute;til por tanto desarrollar nuestras propias tags para el uso
en nuestras aplicaciones. JSP nos ofrece esta posibilidad desde las primeras versiones
del API. </p>


<p>La forma "cl&aacute;sica" de definir tags propias es muy potente y flexible, pero tambi&eacute;n compleja. Por ello, en la
versi&oacute;n 2.0 de JSP se introdujeron alternativas m&aacute;s simples, que son las que veremos aqu&iacute;.</p>

<ul>

<li>
<strong>Tag files</strong>: permiten definir tags como bloques de c&oacute;digo JSP, es decir, son
similares a los <em>includes</em> que ya hemos visto en sesiones anteriores, pero en forma de tags.</li>

<li>
<strong>Simple tags</strong>: usan c&oacute;digo Java para definir las tags, pero el API es mucho m&aacute;s sencillo de usar
que el API "cl&aacute;sico".</li>

</ul>

<a name="N10022"></a><a name="Tag+files"></a>
<h2 class="underlined_10">Tag files</h2>
<div class="section">
<p>Un "tag file" es simplemente un archivo que encapsula un fragmento de c&oacute;digo JSP reutilizable. Por convenio,
estos archivos tienen extensi&oacute;n <span class="codefrag">.tag</span>. El caso m&aacute;s simple ser&iacute;a un bloque de texto fijo. Por ejemplo, supongamos que 
la siguiente l&iacute;nea se guarda en un archivo llamado <span class="codefrag">copyright.tag</span>
</p>
<pre class="code">
Copyright JTECH 2008 
</pre>
<p>Los archivos .tag deben colocarse en un directorio <span class="codefrag">tags</span> dentro de la carpeta <span class="codefrag">WEB-INF</span>. Ahora
podemos usar el tag en nuestro JSP de la misma forma que lo hacemos con taglibs de terceros:</p>
<pre class="code">
&lt;%@ taglib prefix="jtech" tagdir="/WEB-INF/tags" %&gt;
&lt;jtech:copyright/&gt;
</pre>
<p>N&oacute;tese que el nombre del tag es el nombre f&iacute;sico del archivo en que est&aacute; definido.</p>
<p>En este ejemplo tan trivial, usar un tag file ser&iacute;a equivalente a hacer un include. No obstante,como
veremos a continuaci&oacute;n, los tag files permiten el paso de par&aacute;metros de manera m&aacute;s sencilla
que con <span class="codefrag">&lt;jsp:include&gt;</span>, generando por tanto JSPs
mucho m&aacute;s claros y concisos.</p>
<a name="N1004A"></a><a name="Paso+de+par%C3%A1metros"></a>
<h3 class="underlined_5">Paso de par&aacute;metros </h3>
<p>Los archivos de tags se pueden parametrizar. Estos par&aacute;metros se denominan en el est&aacute;ndar JSP <em>atributos</em>
y se definen con la directiva JSP del mismo nombre. Dicha directiva solo es v&aacute;lida en archivos de tag. Por ejemplo, podemos
cambiar <span class="codefrag">copyright.tag</span> por el siguiente:</p>
<pre class="code">
&lt;%@ attribute name="anyo" required="true" rtexprvalue="false"%&gt;
Copyright JTECH ${anyo} 
</pre>
<p>El <span class="codefrag">required</span> especifica si el par&aacute;metro es o no obligatorio y <span class="codefrag">rtexprvalue</span>
si puede usarse EL en el par&aacute;metro o tiene que ser un literal. En nuestro ejemplo debe ser esto &uacute;ltimo. Ahora para usarlo en un JSP, har&iacute;amos</p>
<pre class="code">
&lt;%@ taglib prefix="jtech" tagdir="/WEB-INF/tags" %&gt;
&lt;jtech:copyright anyo="2008"/&gt;
</pre>
<p>Por supuesto, el par&aacute;metro ser&aacute; m&aacute;s &uacute;til si puede ser variable. El siguiente tag est&aacute; preparado
para aceptar una variable Java de tipo Date y formatearla en el formato d&iacute;a/mes/a&ntilde;o:</p>
<pre class="code">
&lt;%@ tag import="java.util.Date" import="java.text.SimpleDateFormat"%&gt;
&lt;%@ attribute name="fecha" required="true" type="java.util.Date" %&gt;	
&lt;%
	SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy");
	out.print(sdf.format(fecha));
%&gt;
</pre>
<p>Hay varios puntos interesantes en el archivo de tag anterior:</p>
<ul>

<li>En la directiva <span class="codefrag">attribute</span>, el <span class="codefrag">type</span> indica el tipo de dato que aceptar&aacute; nuestro tag como par&aacute;metro</li>

<li>La directiva <span class="codefrag">tag</span>, que hasta el momento no hab&iacute;amos necesitado, nos permite importar
los <em>packages</em> necesarios. Es similar a la directiva <span class="codefrag">page</span> usada en los JSP.</li>

<li>Hemos introducido un par de l&iacute;neas de c&oacute;digo Java en forma de <em>scriptlet</em>. Hay que recalcar
que un archivo de tag no es m&aacute;s que un fragmento de JSP, por lo que ser&aacute; v&aacute;lida cualquier construcci&oacute;n
que se pueda usar en un JSP.</li>

</ul>
<p>Ahora para demostrar el uso de nuestra reci&eacute;n creada etiqueta podemos hacer:</p>
<pre class="code">
&lt;%@ taglib prefix="jtech" tagdir="/WEB-INF/tags"%&gt;
&lt;jtech:fmtFecha fecha="&lt;%= new java.util.Date() %&gt;"/&gt;
</pre>
<p>Obs&eacute;rvese que como valor de fecha hemos usado un <em>scriptlet</em> en lugar de una constante,
a diferencia del ejemplo anterior.</p>
<a name="N100A0"></a><a name="Etiquetas+con+contenido"></a>
<h3 class="underlined_5">Etiquetas con contenido</h3>
<p>En todos los ejemplos vistos hasta el momento, el tag creado no ten&iacute;a "cuerpo", solo atributos. Podemos
usar tambi&eacute;n el valor del cuerpo en nuestros tags. Por ejemplo, supongamos un tag propio que pase un texto
a may&uacute;sculas:</p>
<pre class="code">
&lt;%@ taglib prefix="test" tagdir="/WEB-INF/tags"%&gt;
...
&lt;test:capitalizar&gt;Esto es un texto que la etiqueta
deber&iacute;a pasar a may&uacute;sculas&lt;/test:capitalizar&gt;
</pre>
<p>La acci&oacute;n <span class="codefrag">&lt;jsp:body/&gt;</span> obtiene el contenido del cuerpo de nuestro tag. El atributo <span class="codefrag">var</span>
de esta acci&oacute;n nos permite guardarlo en un objeto en &aacute;mbito de p&aacute;gina, petici&oacute;n, sesi&oacute;n o aplicaci&oacute;n. El &aacute;mbito se
controla con el atributo <span class="codefrag">scope</span>. Veamos c&oacute;mo se podr&iacute;a implementar nuestro tag:</p>
<pre class="code">
&lt;jsp:doBody var="texto" scope="request"/&gt;
&lt;%
	String texto = (String) request.getAttribute("texto");
	out.print(texto.toUpperCase());
%&gt;
</pre>
</div>

<a name="N100BF"></a><a name="Simple+tags"></a>
<h2 class="underlined_10">Simple tags</h2>
<div class="section">
<p>En tags propios que requieran gran cantidad de c&oacute;digo java, los <em>scriptlets</em> necesarios
en el archivo de tag pueden volverse demasiado dif&iacute;ciles de mantener, d&aacute;ndose el mismo problema
que tienen los JSP con gran cantidad de c&oacute;digo Java. En ese caso, ser&aacute; mucho mejor encapsular
el c&oacute;digo del tag <em>en una clase Java aparte</em>. Esta idea est&aacute; presente en JSP desde las primeras
versiones. El problema es que cuando se dise&ntilde;&oacute; la forma "cl&aacute;sica" de definir tags con c&oacute;digo Java  
se pens&oacute; en la potencia y flexibilidad, pero no en la facilidad de desarrollo. As&iacute;,
la complejidad de crear tags java de la forma cl&aacute;sica no est&aacute; justificada en la gran mayor&iacute;a de casos,
excepto los m&aacute;s sofisticados. Para resolver este problema, en la versi&oacute;n 2.0 de JSP se introdujo una
forma simplificada de programar tags que se llam&oacute; <strong>simple tags</strong>.</p>
<p>Crear un tag simple implica dos pasos:</p>
<ul>

<li>Escribir la clase Java que implementa el tag</li>

<li>Crear un descriptor de despliegue (.tld)</li>

</ul>
<a name="N100DD"></a><a name="Clase+Java+para+implementar+el+tag"></a>
<h3 class="underlined_5">Clase Java para implementar el tag</h3>
<p>La clase Java que implemente el tag debe implementar el interfaz <span class="codefrag">SimpleTag</span>. Dicho
interfaz tiene los m&eacute;todos que se muestran a continuaci&oacute;n:</p>
<pre class="code">
package javax.servlet.jsp.tagext;
public interface SimpleTag extends JspTag {
	public void doTag() throws JspException, IOException;
	public JspTag getParent();
	public void setJspBody(JspFragment jspBody);
	public void setJspContext(JspContext jspContext);
	public void setParent(JspTag parent);
}
</pre>
<p>Cuando el contenedor web se encuentra con uno de nuestros tags, instancia un objeto de la
clase que lo implementa y va llamando a los m&eacute;todos del interfaz en un cierto orden:</p>
<ol>

<li>
<span class="codefrag">setJspContext</span>: le pasa a nuestro tag la referencia al <span class="codefrag">JspContext</span>,
que nos va a proporcionar, si lo necesitamos, acceso a los diferentes &aacute;mbitos (sesi&oacute;n, aplicaci&oacute;n,...)
y al <span class="codefrag">JspWriter</span> que representa la salida</li>

<li>
<span class="codefrag">setParent</span>: nuestro tag recibir&aacute; informaci&oacute;n de qui&eacute;n es su tag "padre". Eso abre
la posibilidad de anidar tags propios de manera que "colaboren" entre s&iacute;, modificando su comportamiento
y pas&aacute;ndose informaci&oacute;n cuando est&aacute;n anidados.</li>

<li>
<span class="codefrag">setJspBody</span>: nuestro tag recibe tambi&eacute;n el cuerpo que contiene, en forma de objeto
de la clase <span class="codefrag">JspFragment</span>
</li>

<li>
<span class="codefrag">doTag:</span> es el m&eacute;todo m&aacute;s importante. Indica que "es hora de hacer el trabajo".</li>

</ol>
<p>Veamos un ejemplo sencillo, que se limita a mostrar la fecha del sistema en el formato
d&iacute;a/mes/a&ntilde;o</p>
<pre class="code">
package jtech;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
import javax.servlet.jsp.JspException;
import javax.servlet.jsp.tagext.SimpleTagSupport;

public class TestSimpleTag extends SimpleTagSupport {
	public void doTag() throws JspException, IOException {
		SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yy");
		getJspContext().getOut().write(sdf.format(new Date()));
	}
}	
</pre>
<p>En el c&oacute;digo, en lugar de implementar directamente el interfaz <span class="codefrag">SimpleTag</span>,
que nos obligar&iacute;a a definir todos sus m&eacute;todos, los necesitemos o no, hemos heredado de
la clase <span class="codefrag">SimpleTagSupport</span>, que ya incluye una definici&oacute;n por defecto para ellos.</p>
<p>El trabajo de nuestro tag es muy sencillo. A trav&eacute;s del <span class="codefrag">getJspContext().getOut()</span>
obtenemos el <span class="codefrag">JspWriter</span> de la salida y en &eacute;l escribimos la fecha formateada.</p>
<p>Evidentemente este es un ejemplo con un c&oacute;digo tan trivial que no justifica el uso de un tag simple
en lugar de un archivo de tag. No obstante, conforme el n&uacute;mero de l&iacute;neas y la complejidad de c&oacute;digo
va creciendo, la balanza se inclina progresivamente m&aacute;s hacia este tipo de tag, sin olvidar las
posibilidades que se nos dan de anidar tags propios comunic&aacute;ndolos entre s&iacute;.</p>
<a name="N1012C"></a><a name="Descriptor+de+despliegue+%28.tld%29"></a>
<h3 class="underlined_5">Descriptor de despliegue (.tld)</h3>
<p>Se debe crear un archivo .tld en el que, con etiquetas XML describimos las caracter&iacute;sticas
de nuestros nuevos tags. Por convenio, se suele colocar en <span class="codefrag">WEB-INF/tlds</span>, aunque
esto no es obligatorio. Aqu&iacute; tenemos el .tld para nuestro ejemplo:</p>
<pre class="code">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;taglib xmlns="http://java.sun.com/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/javaee/web-jsptaglibrary_2_1.xsd"
  version="2.1"&gt;
  &lt;description&gt;
    Ejemplo de simple tag
  &lt;/description&gt;
  &lt;jsp-version&gt;2.1&lt;/jsp-version&gt;
  &lt;tlib-version&gt;1.0&lt;/tlib-version&gt;
  &lt;short-name&gt;test&lt;/short-name&gt;
  &lt;uri&gt;http://www.jtech.ua.es/ayto/test&lt;/uri&gt;
  &lt;tag&gt;
    &lt;name&gt;test&lt;/name&gt;
    &lt;tag-class&gt;jtech.TestSimpleTag&lt;/tag-class&gt;
    &lt;body-content&gt;empty&lt;/body-content&gt;
    &lt;description&gt;
        Es una prueba tonta, en realidad
    &lt;/description&gt;
  &lt;/tag&gt;
&lt;/taglib&gt;
</pre>
<p>Como vemos, en el descriptor, entre otros datos, decimos qu&eacute; clase Java implementa el tag y cu&aacute;l 
va a ser su nombre en JSP (test). Ahora ya podemos usarlo en nuestros JSPs:</p>
<pre class="code">
&lt;%@ taglib prefix="jtech" uri="WEB-INF/tlds/test.tld"%&gt;
...
&lt;jtech:test/&gt;
</pre>
<a name="N10144"></a><a name="simple+tags+con+atributos"></a>
<h3 class="underlined_5">simple tags con atributos</h3>
<p>Un ejemplo m&aacute;s realista de tag usar&iacute;a atributos. Afortunadamente su uso es muy sencillo. Por
cada atributo que acepte nuestro tag simplemente necesitamos un <em>getter</em> y un <em>setter</em>
en nuestro c&oacute;digo Java. Modificando el ejemplo anterior: </p>
<pre class="code">
public class TestSimpleTag extends SimpleTagSupport {
	private Date fecha;
	
	public void doTag() throws JspException, IOException {
		SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yy");
		getJspContext().getOut().write(sdf.format(fecha));
	}
	public Date getFecha() {
		return fecha;
	}
	public void setFecha(Date fecha) {
		this.fecha = fecha;
	}	
}
</pre>
<p>Ahora nuestro tag admitir&aacute; un atributo <em>fecha</em> en el que le pasamos la
fecha a formatear. Nos falta especificarlo en el .tld:</p>
<pre class="code">
&lt;?xml version="1.0" encoding="UTF-8" ?&gt;
&lt;taglib xmlns="http://java.sun.com/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://java.sun.com/xml/ns/javaee/web-jsptaglibrary_2_1.xsd"
  version="2.1"&gt;
  &lt;description&gt;
    Ejemplo de simple tag
  &lt;/description&gt;
  &lt;jsp-version&gt;2.1&lt;/jsp-version&gt;
  &lt;tlib-version&gt;1.0&lt;/tlib-version&gt;
  &lt;short-name&gt;test&lt;/short-name&gt;
  &lt;uri&gt;http://www.jtech.ua.es/ayto/test&lt;/uri&gt;
  &lt;tag&gt;
    &lt;name&gt;test&lt;/name&gt;
    &lt;tag-class&gt;jtech.TestSimpleTag&lt;/tag-class&gt;
    &lt;body-content&gt;empty&lt;/body-content&gt;
    &lt;description&gt;
        Es una prueba tonta, en realidad
    &lt;/description&gt;
    <strong>&lt;attribute&gt;
	&lt;name&gt;fecha&lt;/name&gt;
	&lt;required&gt;true&lt;/required&gt;
	&lt;rtexprvalue&gt;true&lt;/rtexprvalue&gt;
    &lt;/attribute&gt;</strong>
  &lt;/tag&gt;
&lt;/taglib&gt;
</pre>
</div>

<p class="pageBreakAfter"></p>


</div>
<div class="clearboth">&nbsp;</div>
</div>
<div id="footer">
<div class="lastmodified">
<script type="text/javascript"><!--
document.write("<text>Last Published:</text> " + document.lastModified);
//  --></script>
</div>
<div class="copyright">
        Copyright &copy;
         2008-2009 Depto. CCIA</div>
</div>
</body>
</html>
